<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA SUMAJ - v19.19 (Edici√≥n de Reserva)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { 
            --disponible:#2ecc71; --ocupado:#e74c3c; 
            --sucia: #f1c40f; --limpieza: #3498db;    
            --parcial:#f39c12; --pagado:#2980b9; --historial:#5a6268; 
            --dark:#1a2a3a; --accent:#3498db; 
        }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background: var(--dark) !important; border-bottom: 3px solid var(--accent); }
        .nav-link.active { color: var(--accent) !important; border-bottom: 3px solid var(--accent) !important; }
        
        /* TARJETAS MAPA */
        .hab-card { 
            border-radius: 15px; border: 1px solid #dee2e6; 
            transition: 0.3s; cursor: pointer; background: white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
            border-left: 12px solid transparent; position: relative; overflow: hidden;
            height: 100%;
        }
        .hab-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        
        .status-disponible { border-left-color: var(--disponible); }
        .status-ocupado { border-left-color: var(--ocupado); background: #fff5f5; }
        .status-sucia { border-left-color: var(--sucia); background: #fffff0; }
        .status-limpieza { border-left-color: var(--limpieza); background: #f0f8ff; }

        .piso-header { background: #cbd5e0; color: #2d3748; padding: 8px 15px; border-radius: 8px; margin-top: 30px; font-weight: 800; font-size: 0.9rem; text-transform: uppercase; }
        
        /* CALENDARIO & LISTAS */
        .cal-wrapper { overflow-x: auto; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .table-calendar { font-size: 0.75rem; border-collapse: separate; border-spacing: 1px; width: 100%; min-width: 900px; }
        .table-calendar th { text-align: center; background: #343a40; color: white; padding: 8px; position: sticky; top: 0; z-index: 20; }
        .cal-room-col { background: #212529; color: white; position: sticky; left: 0; z-index: 30; font-weight: bold; width: 60px; text-align: center; }
        .cal-cell { height: 40px; border: 1px solid #dee2e6; vertical-align: middle; text-align: center; min-width: 40px; padding: 0; position: relative; background-color: #fff; }
        .cell-content { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; color: white; cursor: pointer; overflow: hidden; white-space: nowrap; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.4); }
        
        .st-mid { background: var(--ocupado); } 
        .st-start { background: linear-gradient(to right, white 50%, var(--ocupado) 50%); justify-content: flex-end; padding-right: 2px; color: #333; }
        .st-end { background: linear-gradient(to right, var(--ocupado) 50%, white 50%); justify-content: flex-start; padding-left: 2px; color: #333; } 
        .hist-mid { background: var(--historial); }
        .hist-start { background: linear-gradient(to right, white 50%, var(--historial) 50%); }
        .hist-end { background: linear-gradient(to right, var(--historial) 50%, white 50%); }
        .cal-weekend { background-color: #f8f9fa; } 
        .cal-today-col { border-bottom: 3px solid #ffc107 !important; background-color: #fffbe6; }

        /* UTILIDADES LIMPIEZA */
        .clean-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background: white; border-radius: 8px; border-left: 5px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .clean-sucia { border-left-color: var(--sucia); } .clean-limpieza { border-left-color: var(--limpieza); } .clean-ok { border-left-color: var(--disponible); opacity: 0.8; }

        /* UTILIDADES OPERACIONES */
        .op-card { font-size: 0.9rem; margin-bottom: 8px; border-left: 5px solid #ccc; background: white; padding: 12px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .op-in { border-left-color: #2ecc71; } .op-out { border-left-color: #e74c3c; }
        .stock-bajo { color: red; font-weight: bold; }
        .mov-ingreso { color: #198754; font-weight: bold; }
        .mov-egreso { color: #dc3545; font-weight: bold; }

        /* LOGIN */
        #loginOverlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: url('nuestra-habitacion-matrimonial.jpg') no-repeat center center; 
            background-size: cover;
            z-index: 9999; 
            display: flex; align-items: center; justify-content: center; 
        }
        .login-card { 
            background: rgba(255, 255, 255, 0.95);
            padding: 3rem; 
            border-radius: 8px; 
            width: 100%; 
            max-width: 400px; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.6); 
            text-align: center; 
            backdrop-filter: blur(2px);
        }
        .btn-login-custom { background-color: #6d4c41; border: none; color: white; transition: 0.3s; }
        .btn-login-custom:hover { background-color: #5d4037; color: white; }
        .pass-hidden { -webkit-text-security: disc; }
        
        /* ESTILOS EXTRA MODAL */
        .ls-1 { letter-spacing: 1px; }
        .hover-effect:hover { transform: translateY(-2px); transition: 0.2s; }
        
        /* NUEVO ESTILO MODAL HABITACI√ìN */
        .detail-header { background-color: #f8f9fa; border-bottom: 1px solid #e9ecef; border-top-left-radius: 10px; border-top-right-radius: 10px;}
        .detail-label { font-size: 0.7rem; text-transform: uppercase; color: #6c757d; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 2px; }
        .detail-value { font-size: 0.95rem; font-weight: 600; color: #2d3748; }
        .cons-table th { font-size: 0.75rem; text-transform: uppercase; color: #6c757d; font-weight: 600; background: #f8f9fa; }
        .cons-table td { font-size: 0.9rem; vertical-align: middle; }
        .total-box { background: linear-gradient(to right, #f8f9fa, #fff); border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; }
        .debt-high { color: #dc3545; font-size: 1.4rem; font-weight: 800; }
        .debt-ok { color: #198754; font-size: 1.4rem; font-weight: 800; }
        
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2 class="fw-bold mb-4" style="color: #3e2723; font-size: 2rem; letter-spacing: 1px;">SUMAJ LODGE</h2>
        <div class="mb-3 text-start">
            <label class="form-label fw-bold text-secondary small">USUARIO</label>
            <input type="text" id="loginUser" class="form-control form-control-lg bg-white border-secondary-subtle" placeholder="">
        </div>
        <div class="mb-4 text-start">
            <label class="form-label fw-bold text-secondary small">CONTRASE√ëA</label>
            <input type="password" id="loginPass" class="form-control form-control-lg bg-white border-secondary-subtle" placeholder="">
        </div>
        <button class="btn btn-login-custom w-100 fw-bold py-3 fs-6 shadow-sm" onclick="login()">INGRESAR</button>
    </div>
</div>

<div id="appInterface" style="display:none;">
    <nav class="navbar navbar-expand shadow mb-4">
        <div class="container-fluid px-4">
            <span class="navbar-brand fw-bold text-white"><i class="fas fa-hotel me-2"></i>SUMAJ LAGOON LODGE</span>
            <div class="d-flex align-items-center gap-3">
                <div class="text-white small text-end"><div id="userDisplay" class="fw-bold text-warning"></div><div id="reloj" class="fw-light"></div></div>
                <button class="btn btn-sm btn-outline-light" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Salir</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <ul class="nav nav-tabs mb-4 border-0" id="mainTabs">
            <li class="nav-item" id="nav-mapa"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-mapa">üó∫Ô∏è MAPA</button></li>
            <li class="nav-item" id="nav-limpieza"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-limpieza" onclick="renderLimpieza()">üßπ LIMPIEZA</button></li>
            <li class="nav-item" id="nav-calendario"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-calendario" onclick="renderCal()">üìÖ CALENDARIO</button></li>
            <li class="nav-item" id="nav-operaciones"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-operaciones" onclick="actualizarOperaciones()">üìã OPERACIONES</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-caja" onclick="renderCaja()">üí∞ CAJA</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-inventario">üì¶ ALMAC√âN</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-reporte" onclick="actualizarReporte()">üìä REPORTES</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-usuarios" onclick="renderUsuarios()">üë• USUARIOS</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-auditoria" onclick="renderLogs()">üëÅÔ∏è AUDITOR√çA</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-config" onclick="renderConfigHabs()">‚öôÔ∏è CONFIGURACI√ìN</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-mapa">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-3 bg-white p-3 rounded shadow-sm">
                        <div class="d-flex align-items-center gap-3">
                            <span class="small fw-bold text-muted">VISTA: HOY</span>
                            <div class="d-flex gap-2 small">
                                <span class="badge bg-success">Libre</span>
                                <span class="badge bg-danger">Ocupado</span>
                                <span class="badge bg-warning text-dark">Sucia</span>
                                <span class="badge bg-primary">Limpieza</span>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-primary fw-bold shadow-sm" onclick="abrirModalNuevaReserva()">‚ûï NUEVA RESERVA</button>
                            <input type="date" id="filtroFecha" class="form-control w-auto shadow-sm" onchange="actualizarPantalla()">
                        </div>
                    </div>
                    <div id="gridHabitaciones" class="row g-3"></div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-limpieza">
                <div class="card p-4 border-0 shadow-sm">
                    <h5 class="fw-bold mb-4"><i class="fas fa-broom"></i> Gesti√≥n de Limpieza</h5>
                    <div class="row">
                        <div class="col-md-6 border-end">
                            <h6 class="text-danger fw-bold border-bottom pb-2">SUCIAS / EN PROCESO</h6>
                            <div id="listSucias" class="mt-3"></div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success fw-bold border-bottom pb-2">LISTAS</h6>
                            <div id="listLimpias" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-calendario">
                <div class="card border-0 shadow-sm p-3">
                    <div class="d-flex justify-content-between flex-wrap gap-2 align-items-center mb-3 bg-light p-2 rounded">
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-dark" onclick="navMes(-1)"><i class="fas fa-chevron-left"></i></button>
                            <h6 class="m-0 fw-bold text-uppercase" id="calMesTitulo" style="min-width: 150px; text-align:center;"></h6>
                            <button class="btn btn-sm btn-outline-dark" onclick="navMes(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <button class="btn btn-primary btn-sm fw-bold shadow-sm ms-2" onclick="abrirModalReservaCal()">‚ûï NUEVA RESERVA</button>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-danger" onclick="exportarCalPDF()"><i class="fas fa-file-pdf"></i></button>
                            <button class="btn btn-sm btn-dark" onclick="exportarCalImg()"><i class="fas fa-image"></i></button>
                        </div>
                        <input type="hidden" id="calInicio"><input type="hidden" id="calFin">
                    </div>
                    <div id="calContainer" class="cal-wrapper"><table class="table-calendar" id="tablaCal"></table></div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-operaciones"><div class="card p-4 border-0 shadow-sm"><div class="d-flex justify-content-between mb-4"><h5 class="fw-bold">Reporte Operativo</h5><div class="d-flex gap-2"><input type="date" id="fechaOp" class="form-control w-auto" onchange="actualizarOperaciones()"><button class="btn btn-outline-secondary btn-sm" onclick="imprimirOp()">Imprimir</button></div></div><div id="opArea" class="row g-4"><div class="col-md-6 border-end"><h6>LLEGADAS</h6><div id="listIn"></div></div><div class="col-md-6"><h6>SALIDAS</h6><div id="listOut"></div></div></div></div></div>
            <div class="tab-pane fade" id="tab-caja"><div class="row g-4"><div class="col-md-4"><div class="card p-4 border-0 shadow-sm mb-3"><h6 class="fw-bold mb-3 text-primary">Caja Chica</h6><select id="cajaTipo" class="form-select mb-2"><option value="egreso">üî¥ EGRESO</option><option value="ingreso">üü¢ INGRESO</option></select><select id="cajaCat" class="form-select mb-2"><option>Compras</option><option>Servicios</option><option>Otros</option></select><input type="text" id="cajaDesc" class="form-control mb-2" placeholder="Descripci√≥n"><input type="number" id="cajaMonto" class="form-control mb-2" placeholder="Monto"><button class="btn btn-dark w-100" onclick="guardarMovimientoCaja()">REGISTRAR</button></div><div class="card bg-warning bg-opacity-10 p-3 text-center"><h6 class="fw-bold">SALDO</h6><h2 class="fw-bold text-warning" id="cajaSaldo">S/ 0.00</h2></div></div><div class="col-md-8"><div class="card p-4 border-0 shadow-sm"><table class="table table-sm" id="tablaCaja"><thead class="table-light"><tr><th>Fecha</th><th>Tipo</th><th>Desc</th><th>Monto</th><th></th></tr></thead><tbody id="bodyCaja"></tbody></table></div></div></div></div>
            <div class="tab-pane fade" id="tab-inventario"><div class="row g-4"><div class="col-md-4"><div class="card p-4 border-0 shadow-sm"><h6>Nuevo Item</h6><select id="invTipo" class="form-select mb-2" onchange="toggleStockInput()"><option value="producto">Producto</option><option value="servicio">Servicio</option></select><input type="text" id="invNombre" class="form-control mb-2" placeholder="Nombre"><input type="number" id="invPrecio" class="form-control mb-2" placeholder="Precio"><div id="divStockInput"><input type="number" id="invStock" class="form-control mb-2" placeholder="Stock"></div><button class="btn btn-success w-100" onclick="agregarProducto()">GUARDAR</button></div></div><div class="col-md-8"><div class="card p-4 border-0 shadow-sm"><table class="table table-sm"><thead class="table-light"><tr><th>Item</th><th>Tipo</th><th>Precio</th><th>Stock</th><th>Acci√≥n</th></tr></thead><tbody id="tablaInventario"></tbody></table></div></div></div></div>
            <div class="tab-pane fade" id="tab-reporte"><div class="row g-3 mb-4"><div class="col-md-3"><div class="card p-3 border-0 shadow-sm"><label class="small fw-bold">Desde</label><input type="date" id="hist_desde" class="form-control" onchange="actualizarReporte()"></div></div><div class="col-md-3"><div class="card p-3 border-0 shadow-sm"><label class="small fw-bold">Hasta</label><input type="date" id="hist_hasta" class="form-control" onchange="actualizarReporte()"></div></div><div class="col-md-6 d-flex align-items-end"><button class="btn btn-success me-2" onclick="exportarExcel()">Excel</button></div></div><div class="row mb-4"><div class="col-md-3"><div class="card card-dash bg-success p-3 text-white"><div>INGRESOS</div><h3 id="dashCobrado">S/ 0.00</h3></div></div><div class="col-md-3"><div class="card card-dash bg-secondary p-3 text-white"><div>GASTOS</div><h3 id="dashGastos">S/ 0.00</h3></div></div><div class="col-md-3"><div class="card card-dash bg-primary p-3 text-white"><div>UTILIDAD</div><h3 id="dashUtilidad">S/ 0.00</h3></div></div><div class="col-md-3"><div class="card card-dash bg-danger p-3 text-white"><div>PENDIENTE</div><h3 id="dashPendiente">S/ 0.00</h3></div></div></div><div id="captureArea" class="card border-0 shadow-sm p-4"><div class="table-responsive"><table class="table table-hover small" id="tablaHistorialHTML"><thead class="table-dark"><tr><th>Hab</th><th>Pax</th><th>Nombre</th><th>In/Out</th><th>Total</th><th>Pagado</th><th>Cierre</th></tr></thead><tbody id="tablaHistorial"></tbody></table></div></div></div>
            <div class="tab-pane fade" id="tab-usuarios"><div class="row"><div class="col-md-4"><div class="card p-4 border-0 shadow-sm"><h6 class="fw-bold mb-3">Usuario</h6><input type="hidden" id="editUserIndex" value="-1"><label class="small">Usuario</label><input type="text" id="newUserName" class="form-control mb-2"><label class="small">Contrase√±a</label><input type="text" id="newUserPass" class="form-control mb-2"><label class="small fw-bold mt-2">M√≥dulos:</label><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-mapa"><label>Mapa</label></div><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-limpieza"><label>Limpieza</label></div><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-calendario" checked><label>Calendario</label></div><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-operaciones" checked><label>Operaciones</label></div><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-caja"><label>Caja</label></div><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-inventario"><label>Almac√©n</label></div><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-reporte"><label>Reportes</label></div><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-config"><label>Configuraci√≥n</label></div><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-usuarios"><label>Admin</label></div><div class="d-flex gap-2 mt-3"><button class="btn btn-primary w-100" onclick="guardarUsuario()">Guardar</button><button class="btn btn-outline-secondary" onclick="limpiarFormUsuario()">Limpiar</button></div></div></div><div class="col-md-8"><div class="card p-4 border-0 shadow-sm"><table class="table table-hover table-sm small"><thead class="table-light"><tr><th>User</th><th>Pass</th><th>Permisos</th><th></th></tr></thead><tbody id="tablaUsuarios"></tbody></table></div></div></div></div>
            <div class="tab-pane fade" id="tab-auditoria"><div class="card p-4 border-0 shadow-sm"><div class="d-flex justify-content-between mb-3"><h6 class="fw-bold">Logs</h6><div class="d-flex gap-2"><select id="filterUser" class="form-select form-select-sm" onchange="renderLogs()"><option value="">Todos</option></select><input type="date" id="filterDateFrom" class="form-control form-control-sm" onchange="renderLogs()"><input type="date" id="filterDateTo" class="form-control form-control-sm" onchange="renderLogs()"><button class="btn btn-sm btn-secondary" onclick="imprimirLogs()">Imprimir</button></div></div><div class="table-responsive" id="printLogsArea"><table class="table table-striped table-sm log-table"><thead class="table-dark"><tr><th>Fecha</th><th>User</th><th>Acci√≥n</th><th>Detalle</th></tr></thead><tbody id="tablaLogs"></tbody></table></div></div></div>
            
            <div class="tab-pane fade" id="tab-config">
                <div class="row g-4">
                    <div class="col-md-5">
                        <div class="card p-4 border-0 shadow-sm">
                            <h6 class="fw-bold mb-3">üõ†Ô∏è Copias de Seguridad</h6>
                            <button class="btn btn-primary w-100 mb-2" onclick="descargarBackup()">‚¨áÔ∏è DESCARGAR DATA</button>
                            <hr>
                            <input type="file" id="fileBackup" class="form-control mb-2">
                            <button class="btn btn-warning w-100" onclick="restaurarBackup()">‚¨ÜÔ∏è RESTAURAR</button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="card p-4 border-0 shadow-sm">
                            <h6 class="fw-bold mb-3">üè® Gesti√≥n de Habitaciones</h6>
                            <div class="input-group mb-3">
                                <input type="number" id="confNum" class="form-control" placeholder="N¬∞ Hab">
                                <input type="text" id="confPiso" class="form-control" placeholder="Piso/Sec">
                                <button class="btn btn-dark" onclick="agregarHabitacion()">‚ûï Agregar</button>
                            </div>
                            <div class="table-responsive" style="max-height: 400px; overflow-y:auto;">
                                <table class="table table-sm table-hover align-middle">
                                    <thead class="table-light"><tr><th>Hab</th><th>Piso</th><th>Acci√≥n</th></tr></thead>
                                    <tbody id="bodyConfigHabs"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNuevoIngreso" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            
            <div class="modal-header bg-primary text-white p-4" style="background: linear-gradient(135deg, #1a2a3a 0%, #2980b9 100%);">
                <div>
                    <h5 class="fw-bold m-0"><i class="fas fa-concierge-bell me-2"></i>Nuevo Check-In</h5>
                    <small class="text-white-50">Registre los datos de ingreso y facturaci√≥n</small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body p-0">
                <div class="row g-0">
                    
                    <div class="col-md-7 p-4">
                        <h6 class="text-primary fw-bold mb-3 text-uppercase small ls-1"><i class="fas fa-user-circle me-1"></i> Datos del Hu√©sped</h6>
                        
                        <div class="row g-2 mb-4">
                            <div class="col-4">
                                <label class="form-label small text-muted fw-bold">DNI / Doc</label>
                                <input type="text" id="dni" class="form-control form-control-sm bg-light" placeholder="12345678">
                            </div>
                            <div class="col-8">
                                <label class="form-label small text-muted fw-bold">Nombre Completo</label>
                                <input type="text" id="cliente" class="form-control form-control-sm fw-bold" placeholder="Nombre del Cliente">
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-muted fw-bold">Celular</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-white"><i class="fas fa-phone small text-muted"></i></span>
                                    <input type="text" id="c_celular" class="form-control" placeholder="999...">
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-muted fw-bold">Pax (Personas)</label>
                                <input type="number" id="numPersonas" class="form-control form-control-sm" value="1" min="1">
                            </div>
                        </div>

                        <h6 class="text-primary fw-bold mb-3 text-uppercase small ls-1 border-top pt-3"><i class="fas fa-bed me-1"></i> Estancia</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label small text-muted fw-bold">Habitaci√≥n</label>
                                <select id="habSelect" class="form-select form-select-sm fw-bold border-primary" onchange="checkTipoHab('mapa')"></select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-muted fw-bold">Tipo</label>
                                <select id="tipoHab" class="form-select form-select-sm bg-light"></select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-muted fw-bold">Llegada</label>
                                <input type="date" id="checkin" class="form-control form-control-sm">
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-muted fw-bold">Salida</label>
                                <input type="date" id="checkout" class="form-control form-control-sm">
                            </div>
                        </div>
                    </div>

                    <div class="col-md-5 bg-light p-4 border-start d-flex flex-column justify-content-between">
                        <div>
                            <h6 class="text-success fw-bold mb-3 text-uppercase small ls-1"><i class="fas fa-file-invoice-dollar me-1"></i> Facturaci√≥n</h6>
                            
                            <div class="card border-0 shadow-sm mb-3">
                                <div class="card-body p-3">
                                    <label class="small fw-bold mb-1 text-muted">Monto Total</label>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text bg-white border-end-0 fw-bold text-success">S/</span>
                                        <input type="number" id="total" class="form-control border-start-0 fs-4 fw-bold text-dark" value="0">
                                    </div>

                                    <div class="mb-3">
                                        <label class="small text-muted fw-bold">Estado del Pago</label>
                                        <select id="pagoEstado" class="form-select form-select-sm fw-bold" onchange="toggleAdelanto()">
                                            <option value="Falta Pagar" class="text-danger">üî¥ Falta Pagar</option>
                                            <option value="Pagado" class="text-success">üü¢ Pagado Completo</option>
                                            <option value="Adelanto" class="text-warning">üü† Dejar Adelanto</option>
                                        </select>
                                    </div>

                                    <div id="divAdelanto" style="display:none;" class="mb-3 p-2 bg-warning bg-opacity-10 rounded border border-warning">
                                        <label class="small fw-bold text-dark">Monto Adelanto</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-white text-dark">S/</span>
                                            <input type="number" id="adelanto" class="form-control fw-bold" value="0">
                                        </div>
                                    </div>

                                    <div>
                                        <label class="small text-muted fw-bold">Medio de Pago</label>
                                        <select id="medioPago" class="form-select form-select-sm">
                                            <option>Efectivo</option>
                                            <option>Yape</option>
                                            <option>Plin</option>
                                            <option>Tarjeta</option>
                                            <option>Transferencia</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-primary w-100 py-3 fw-bold shadow hover-effect" onclick="guardarReserva()">
                            <i class="fas fa-check-circle me-2"></i> CONFIRMAR RESERVA
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalH" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content border-0 shadow-lg"><div id="mh" class="modal-header detail-header"><h5 id="mt" class="fw-bold m-0 text-dark"><i class="fas fa-door-open me-2 text-primary"></i>Detalle Habitaci√≥n</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0" id="mb"></div></div></div></div>

<div class="modal fade" id="modalResCal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg"><div class="modal-header bg-primary text-white"><h5 class="fw-bold m-0">‚ûï Nueva Reserva (Cal)</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><div class="row g-2"><div class="col-12"><label class="small fw-bold">Nombre</label><input type="text" id="c_cliente" class="form-control form-control-sm"></div><div class="col-8"><label class="small fw-bold">DNI</label><input type="text" id="c_dni" class="form-control form-control-sm"></div><div class="col-4"><label class="small fw-bold">Personas</label><input type="number" id="c_numPersonas" class="form-control form-control-sm" value="1" min="1"></div><div class="col-12"><label class="small fw-bold">Celular</label><input type="text" id="c_celular_cal" class="form-control form-control-sm"></div><div class="col-6"><label class="small fw-bold">Habitaci√≥n</label><select id="c_habSelect" class="form-select form-select-sm" onchange="checkTipoHab('cal')"></select></div><div class="col-6"><label class="small fw-bold">Tipo</label><select id="c_tipoHab" class="form-select form-select-sm"></select></div><div class="col-6"><label class="small fw-bold">Ingreso</label><input type="date" id="c_in" class="form-control form-control-sm"></div><div class="col-6"><label class="small fw-bold">Salida</label><input type="date" id="c_out" class="form-control form-control-sm"></div><div class="col-6"><label class="small fw-bold">Total S/</label><input type="number" id="c_total" class="form-control form-control-sm" value="0"></div><div class="col-6"><label class="small fw-bold">Medio</label><select id="c_medioPago" class="form-select form-select-sm"><option>Efectivo</option><option>Yape</option><option>Plin</option><option>Tarjeta</option></select></div><div class="col-12"><label class="small fw-bold">Pago</label><select id="c_pagoEstado" class="form-select form-select-sm" onchange="toggleAdelantoCal()"><option value="Falta Pagar">Falta Pagar</option><option value="Pagado">Pagado</option><option value="Adelanto">Adelanto</option></select></div><div class="col-12" id="divAdelantoCal" style="display:none;"><label class="small fw-bold">Adelanto S/</label><input type="number" id="c_adelanto" class="form-control form-control-sm" value="0"></div></div><div class="col-12"><button class="btn btn-primary w-100 fw-bold mt-3" onclick="guardarReservaCal()">Confirmar</button></div></div></div></div></div>

<script>
    const { jsPDF } = window.jspdf;
    
    // --- FECHA LOCAL CORRECTA ---
    const now = new Date();
    const offset = now.getTimezoneOffset() * 60000;
    const localDate = new Date(now.getTime() - offset);
    const hoy = localDate.toISOString().split('T')[0];
    
    // --- DATOS ---
    let defaultHabs = [
        {num:101, piso:'Piso 1'}, {num:102, piso:'Piso 1'}, {num:103, piso:'Piso 1'}, {num:104, piso:'Piso 1'}, {num:105, piso:'Piso 1'}, {num:106, piso:'Piso 1'}, {num:107, piso:'Piso 1'}, {num:108, piso:'Piso 1'},
        {num:201, piso:'Piso 2'}, {num:202, piso:'Piso 2'}, {num:203, piso:'Piso 2'}, {num:204, piso:'Piso 2'}, {num:205, piso:'Piso 2'}, {num:206, piso:'Piso 2'}, {num:207, piso:'Piso 2'}, {num:208, piso:'Piso 2'},
        {num:1, piso:'Departamento', tipo:'Familiar'}, 
        {num:2, piso:'Departamento', tipo:'Matrimonial Vista'}, 
        {num:3, piso:'Departamento', tipo:'Matrimonial'},
        {num:4, piso:'Muelle', tipo:'Matrimonial Muelle'}, 
        {num:5, piso:'Muelle', tipo:'Matrimonial Muelle'}
    ];

    let habs = JSON.parse(localStorage.getItem('sumaj_habs_v7')) || defaultHabs;
    let ress = JSON.parse(localStorage.getItem('sumaj_ress_v5')) || [];
    let historial = JSON.parse(localStorage.getItem('sumaj_hist_v5')) || [];
    let inventario = JSON.parse(localStorage.getItem('sumaj_inv_v2')) || [];
    let caja = JSON.parse(localStorage.getItem('sumaj_caja_v1')) || [];
    let users = JSON.parse(localStorage.getItem('sumaj_users_v1')) || [{ user: 'admin', pass: 'admin707', modules: ['all'] }]; 
    let logs = JSON.parse(localStorage.getItem('sumaj_logs_v1')) || []; 
    let limpieza = JSON.parse(localStorage.getItem('sumaj_clean_v1')) || {}; 
    
    let currentUser = null;
    let modalInstance = null;
    let modalResCal = null;
    let modalNuevoIngreso = null; 
    let showPass = false;
    let calDate = new Date(); 

    // --- LOGIN ---
    function login() {
        const u = document.getElementById('loginUser').value;
        const p = document.getElementById('loginPass').value;
        const userFound = users.find(x => x.user === u && x.pass === p);
        if (userFound) {
            currentUser = userFound;
            localStorage.setItem('sumaj_session', JSON.stringify(currentUser)); 
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('appInterface').style.display = 'block';
            document.getElementById('userDisplay').innerText = `üë§ ${currentUser.user.toUpperCase()}`;
            aplicarPermisos();
            registrarLog("LOGIN", "Ingreso al sistema");
            initSystem();
        } else { alert("Credenciales incorrectas"); }
    }
    
    function logout() { 
        localStorage.removeItem('sumaj_session');
        registrarLog("LOGOUT", "Salida"); 
        location.reload(); 
    }
    
    // Auto Login Check
    const savedSession = localStorage.getItem('sumaj_session');
    if(savedSession) {
        currentUser = JSON.parse(savedSession);
        const valid = users.find(u => u.user === currentUser.user && u.pass === currentUser.pass);
        if(valid) {
            currentUser = valid;
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('appInterface').style.display = 'block';
            document.getElementById('userDisplay').innerText = `üë§ ${currentUser.user.toUpperCase()}`;
            setTimeout(() => { aplicarPermisos(); initSystem(); }, 100);
        } else {
            localStorage.removeItem('sumaj_session');
        }
    }

    function aplicarPermisos() {
        document.querySelectorAll('.nav-item').forEach(el => el.style.display = 'none');
        let firstTab = null;
        if (currentUser.modules.includes('all')) {
            document.querySelectorAll('.nav-item').forEach(el => el.style.display = 'block');
            firstTab = '#tab-mapa';
        } else {
            currentUser.modules.forEach(modId => {
                const el = document.getElementById(modId);
                if(el) { el.style.display = 'block'; if(!firstTab) firstTab = el.querySelector('button').getAttribute('data-bs-target'); }
            });
        }
        if(firstTab) { const triggerEl = document.querySelector(`button[data-bs-target="${firstTab}"]`); if(triggerEl) bootstrap.Tab.getOrCreateInstance(triggerEl).show(); }
    }

    function registrarLog(accion, detalle) {
        logs.unshift({ dateIso: new Date().toISOString(), dateStr: new Date().toLocaleString(), user: currentUser ? currentUser.user : 'system', action: accion, details: detalle });
        if(logs.length > 1000) logs.pop(); 
        localStorage.setItem('sumaj_logs_v1', JSON.stringify(logs));
    }
    function checkPermiso(modId) { return currentUser.modules.includes('all') || currentUser.modules.includes(modId); }
    function verificarPermisoAdmin() { if (currentUser.modules.includes('all') || currentUser.user === 'admin') return true; alert("‚õî Acceso Denegado"); return false; }

    function abrirModalNuevaReserva() {
        if(!modalNuevoIngreso) modalNuevoIngreso = new bootstrap.Modal(document.getElementById('modalNuevoIngreso'));
        document.getElementById('cliente').value = '';
        document.getElementById('dni').value = '';
        document.getElementById('numPersonas').value = '1';
        document.getElementById('c_celular').value = '';
        document.getElementById('total').value = '0';
        document.getElementById('adelanto').value = '0';
        document.getElementById('checkin').value = hoy;
        document.getElementById('checkout').value = hoy;
        toggleAdelanto();
        checkTipoHab('mapa');
        modalNuevoIngreso.show();
    }

    function checkTipoHab(origin) {
        const habId = origin === 'mapa' ? 'habSelect' : 'c_habSelect';
        const tipoId = origin === 'mapa' ? 'tipoHab' : 'c_tipoHab';
        
        const selHab = parseInt(document.getElementById(habId).value);
        const selTipo = document.getElementById(tipoId);
        
        const habitacion = habs.find(h => h.num === selHab);
        
        if (habitacion) {
            if (habitacion.piso === 'Departamento' || habitacion.piso === 'Muelle') {
                selTipo.innerHTML = `<option value="${habitacion.tipo}" selected>${habitacion.tipo}</option>`;
                selTipo.disabled = true;
            } else {
                selTipo.disabled = false;
                selTipo.innerHTML = `<option>Simple</option><option>Matrimonial</option><option>Doble</option><option>Triple</option><option>Suite</option>`;
            }
        }
    }

    function renderLimpieza() {
        const listSucias = document.getElementById('listSucias');
        const listLimpias = document.getElementById('listLimpias');
        listSucias.innerHTML = ''; listLimpias.innerHTML = '';

        habs.sort((a,b)=>a.num-b.num).forEach(h => {
            const estado = limpieza[h.num] || 'limpia';
            const r = ress.find(res => res.habNum == h.num && (hoy >= res.in && hoy < res.out));
            if(r) return; 

            const html = `<div class="clean-row ${estado === 'sucia' ? 'clean-sucia' : (estado === 'limpieza' ? 'clean-limpieza' : 'clean-ok')}"><strong>Hab ${String(h.num).padStart(3, '0')}</strong><span>${estado.toUpperCase()}</span><div>${estado === 'sucia' ? `<button class="btn btn-sm btn-primary" onclick="setEstadoLimpieza(${h.num}, 'limpieza')">Limpiar</button>` : ''}${estado === 'limpieza' ? `<button class="btn btn-sm btn-success" onclick="setEstadoLimpieza(${h.num}, 'limpia')">Terminar</button>` : ''}${estado === 'limpia' ? `<button class="btn btn-sm btn-outline-warning" onclick="setEstadoLimpieza(${h.num}, 'sucia')">Marcar Sucia</button>` : ''}</div></div>`;
            
            if(estado === 'limpia') listLimpias.innerHTML += html;
            else listSucias.innerHTML += html;
        });
    }

    function setEstadoLimpieza(num, estado) {
        limpieza[num] = estado;
        localStorage.setItem('sumaj_clean_v1', JSON.stringify(limpieza));
        registrarLog("LIMPIEZA", `Hab ${num} a estado ${estado}`);
        renderLimpieza();
        actualizarPantalla();
    }

    // --- MAPA ---
    function actualizarPantalla(){
        const f = document.getElementById('filtroFecha').value;
        const grid = document.getElementById('gridHabitaciones');
        const select = document.getElementById('habSelect');
        const selectCal = document.getElementById('c_habSelect'); 
        
        grid.innerHTML = ''; 
        select.innerHTML = '';
        if(selectCal) selectCal.innerHTML = '';

        const pisos = [...new Set(habs.map(h => h.piso))].sort();
        
        pisos.forEach(p => { 
            const label = String(p).includes('Piso') ? p : `SECCI√ìN ${p.toUpperCase()}`;
            grid.innerHTML += `<div class="col-12"><div class="piso-header mb-2">${label}</div></div>`; 
            
            const groupHabs = habs.filter(h => h.piso === p).sort((a,b)=>a.num-b.num);
            
            groupHabs.forEach(h => {
                const r = ress.find(x => x.habNum == h.num && (f >= x.in && f < x.out)); // Corregido logica < out
                const estadoLimpieza = limpieza[h.num] || 'limpia';
                
                let cardClass = 'hab-card';
                let statusBadge = '<span class="badge bg-success">Libre</span>';
                let info = `<div class="small text-muted">Disponible</div>`;
                
                if (r) {
                    const tCons = (r.consumos||[]).reduce((a,b)=>a+(b.precio*b.cantidad),0);
                    const deu = (r.total + tCons) - r.adelanto;
                    cardClass += ' status-ocupado'; 
                    statusBadge = `<span class="badge bg-danger">Ocupado</span>`;
                    info = `<div class="small fw-bold text-primary text-truncate">${r.cliente}</div>`;
                    if (deu > 0.1) info += `<div class="small text-danger fw-bold">Deuda: S/ ${deu.toFixed(2)}</div>`;
                    else info += `<div class="small text-success fw-bold">Pagado</div>`;
                } else if (estadoLimpieza === 'sucia') {
                    cardClass += ' status-sucia';
                    statusBadge = `<span class="badge bg-warning text-dark">Sucia</span>`;
                    info = `<div class="small text-warning fw-bold">Limpieza Pendiente</div>`;
                } else if (estadoLimpieza === 'limpieza') {
                    cardClass += ' status-limpieza';
                    statusBadge = `<span class="badge bg-primary">Limpieza</span>`;
                    info = `<div class="small text-primary fw-bold">Limpiando...</div>`;
                } else {
                    cardClass += ' status-disponible';
                }

                const dispNum = h.piso.includes('Piso') ? h.num : String(h.num).padStart(3, '0');
                const tipoLabel = h.tipo ? `<div style="font-size:0.7rem" class="text-muted text-truncate">${h.tipo}</div>` : '';

                grid.innerHTML += `<div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 mb-3"><div class="${cardClass} p-3" onclick="verDetalle(${h.num}, ${r?r.id:null})"><div class="d-flex justify-content-between mb-1"><b class="fs-5">${dispNum}</b>${statusBadge}</div>${tipoLabel}${info}</div></div>`;
                
                const opt = `<option value="${h.num}">${dispNum} ${h.tipo?`(${h.tipo})`:''}</option>`;
                select.innerHTML += opt;
                if(selectCal) selectCal.innerHTML += opt;
            });
        });
        
        checkTipoHab('mapa');
    }

    function checkOut(id,d){
        if(d>0.1)return alert("‚ö†Ô∏è Hay deuda.");
        if(!confirm("¬øFinalizar estancia y marcar para LIMPIEZA?"))return;
        
        const r=ress.find(x=>x.id==id);
        const tC=(r.consumos||[]).reduce((a,b)=>a+(b.precio*b.cantidad),0);
        r.totalFinal=r.total+tC; r.fechaCierre=new Date().toLocaleString();
        
        limpieza[r.habNum] = 'sucia';
        localStorage.setItem('sumaj_clean_v1', JSON.stringify(limpieza));

        historial.push(r); ress=ress.filter(x=>x.id!==id);
        localStorage.setItem('sumaj_hist_v5',JSON.stringify(historial));
        localStorage.setItem('sumaj_ress_v5',JSON.stringify(ress));
        registrarLog("CHECK_OUT", `Hab ${r.habNum} - ${r.cliente}`);
        
        modalInstance.hide(); 
        actualizarPantalla(); 
        actualizarReporte(); 
        renderCal();
        renderLimpieza(); 
    }

    function navMes(delta) {
        calDate.setMonth(calDate.getMonth() + delta);
        calDate.setDate(1); 
        renderCal();
    }

    function renderCal() {
        const t = document.getElementById('tablaCal'); 
        t.innerHTML = '';
        const year = calDate.getFullYear();
        const month = calDate.getMonth();
        const daysCount = new Date(year, month + 1, 0).getDate();
        const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
        document.getElementById('calMesTitulo').innerText = `${meses[month]} ${year}`;

        let head = '<thead><tr><th class="cal-room-col">HAB</th>';
        const dates = [];
        for(let i = 1; i <= daysCount; i++){
            const d = new Date(year, month, i);
            const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            dates.push(iso);
            const wD = ["D","L","M","M","J","V","S"][d.getDay()];
            head += `<th class="${iso===hoy?'cal-today-col':''}">${wD}<br>${i}</th>`;
        }
        head += '</tr></thead><tbody>';
        
        habs.forEach(h => {
            const dispNum = h.piso.includes('Piso') ? h.num : String(h.num).padStart(3, '0');
            head += `<tr><td class="cal-room-col">${dispNum}</td>`;
            dates.forEach(dayIso => {
                const activeIn = ress.find(r => r.habNum == h.num && r.in === dayIso);
                const activeOut = ress.find(r => r.habNum == h.num && r.out === dayIso);
                const activeMid = ress.find(r => r.habNum == h.num && dayIso > r.in && dayIso < r.out);
                const histIn = historial.find(r => r.habNum == h.num && r.in === dayIso);
                const histOut = historial.find(r => r.habNum == h.num && r.out === dayIso);
                const histMid = historial.find(r => r.habNum == h.num && dayIso > r.in && dayIso < r.out);

                let cellHTML = '';
                const styleDiv = (r, type, isHist) => {
                    const color = isHist ? 'var(--historial)' : getColorStatus(r);
                    let grad = '';
                    if (type === 'start') grad = `linear-gradient(to right, white 50%, ${color} 50%)`; 
                    else if (type === 'end') grad = `linear-gradient(to right, ${color} 50%, white 50%)`; 
                    else grad = color; 
                    return `background:${grad}; color:white; justify-content:${type==='start'?'flex-end':'center'}; padding-right:${type==='start'?'2px':'0'}; padding-left:${type==='end'?'2px':'0'};`;
                }

                if (activeMid) cellHTML = `<div class="cell-content" style="${styleDiv(activeMid, 'mid', false)}" onclick="verDetalle(${h.num},${activeMid.id})">${activeMid.cliente.split(' ')[0]}</div>`; 
                else if (activeIn && activeOut) { const cOut = getColorStatus(activeOut); const cIn = getColorStatus(activeIn); const mix = `background: linear-gradient(to right, ${cOut} 48%, white 48%, white 52%, ${cIn} 52%); color: white;`; cellHTML = `<div class="cell-content" style="${mix}" onclick="verDetalle(${h.num},${activeIn.id})">‚áÑ</div>`; } 
                else if (activeIn) cellHTML = `<div class="cell-content" style="${styleDiv(activeIn, 'start', false)}" onclick="verDetalle(${h.num},${activeIn.id})">${activeIn.cliente.split(' ')[0]}</div>`; 
                else if (activeOut) cellHTML = `<div class="cell-content" style="${styleDiv(activeOut, 'end', false)}" onclick="verDetalle(${h.num},${activeOut.id})"></div>`; 
                else if (histMid) cellHTML = `<div class="cell-content" style="${styleDiv(histMid, 'mid', true)}" onclick="verDetalle(${h.num},${histMid.id},true)">‚úì ${histMid.cliente.split(' ')[0]}</div>`; 
                else if (histIn) cellHTML = `<div class="cell-content" style="${styleDiv(histIn, 'start', true)}" onclick="verDetalle(${h.num},${histIn.id},true)">‚úì ${histIn.cliente.split(' ')[0]}</div>`; 
                else if (histOut) cellHTML = `<div class="cell-content" style="${styleDiv(histOut, 'end', true)}" onclick="verDetalle(${h.num},${histOut.id},true)"></div>`;

                head += `<td class="cal-cell ${new Date(dayIso).getDay()===0||new Date(dayIso).getDay()===6?'cal-weekend':''}">${cellHTML}</td>`;
            });
            head += '</tr>';
        });
        t.innerHTML = head + '</tbody>';
    }

    function getColorStatus(r) { if(r.adelanto >= r.total) return 'var(--pagado)'; if(r.adelanto > 0) return 'var(--parcial)'; return 'var(--ocupado)'; }

    function initSystem() {
        document.getElementById('checkin').value = hoy; document.getElementById('checkout').value = hoy;
        document.getElementById('filtroFecha').value = hoy; document.getElementById('fechaOp').value = hoy;
        calDate = new Date(); calDate.setDate(1); 
        actualizarPantalla(); renderConfigHabs(); renderCal(); 
        if(checkPermiso('nav-reporte')) actualizarReporte(); 
        if(checkPermiso('nav-caja')) renderCaja(); 
        if(checkPermiso('nav-inventario')) renderInventario();
        if(checkPermiso('nav-usuarios')) { renderUsuarios(); renderLogs(); }
        renderLimpieza();
        setInterval(()=>document.getElementById('reloj').innerText=new Date().toLocaleString(),1000);
    }

    // CAMBIO v19.19: MODIFICADA VALIDACI√ìN PARA EXCLUIR ID AL EDITAR
    function validarDisponibilidad(h, i, o, excludeId = null){
        return !ress.some(r => {
            if(excludeId && r.id === excludeId) return false; // Ignorar la propia reserva al editar
            return r.habNum == h && i < r.out && o > r.in;
        });
    }

    function guardarReserva() { 
        const d=(id)=>document.getElementById(id).value; 
        const t=parseFloat(d('total'))||0; 
        let ad=d('pagoEstado')==='Pagado'?t:(d('pagoEstado')==='Adelanto'?parseFloat(d('adelanto')):0); 
        
        if(!d('cliente'))return alert("Falta nombre"); 
        
        const selHab = parseInt(d('habSelect'));
        let tipo = d('tipoHab');
        if(document.getElementById('tipoHab').disabled) {
            const hObj = habs.find(h=>h.num === selHab);
            if(hObj) tipo = hObj.tipo;
        }

        if(limpieza[selHab]==='sucia'||limpieza[selHab]==='limpieza'){if(!confirm("Habitaci√≥n Sucia/Limpieza. ¬øAsignar?"))return;} 
        if(!validarDisponibilidad(selHab,d('checkin'),d('checkout')))return alert("Ocupado"); 
        
        ress.push({id:Date.now(),cliente:d('cliente'),dni:d('dni'),personas:d('numPersonas'),celular:d('c_celular'),habNum:selHab,tipo:tipo,in:d('checkin'),out:d('checkout'),total:t,adelanto:ad,medioPago:d('medioPago'),consumos:[]}); 
        localStorage.setItem('sumaj_ress_v5',JSON.stringify(ress)); 
        registrarLog("RESERVA",`Hab ${d('habSelect')} - ${d('cliente')}`); 
        actualizarPantalla(); alert("Guardado"); renderCal(); 
        
        if(modalNuevoIngreso) modalNuevoIngreso.hide();
    }

    // --- CAMBIO v19.19: FUNCIONES DE EDICI√ìN ---
    function editarReserva(id) {
        const r = ress.find(x => x.id == id);
        if(!r) return;

        const htmlForm = `
            <div class="row g-3 p-4">
                <h5 class="fw-bold mb-3 border-bottom pb-2">Editar Datos de Reserva</h5>
                <div class="col-md-6">
                    <label class="small fw-bold">Nombre Hu√©sped</label>
                    <input type="text" id="edit_cliente" class="form-control" value="${r.cliente}">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">DNI</label>
                    <input type="text" id="edit_dni" class="form-control" value="${r.dni || ''}">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">Celular</label>
                    <input type="text" id="edit_celular" class="form-control" value="${r.celular || ''}">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">Pax (Personas)</label>
                    <input type="number" id="edit_personas" class="form-control" value="${r.personas || 1}">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold text-success">Check-IN</label>
                    <input type="date" id="edit_in" class="form-control" value="${r.in}">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold text-danger">Check-OUT</label>
                    <input type="date" id="edit_out" class="form-control" value="${r.out}">
                </div>
                 <div class="col-md-12">
                    <label class="small fw-bold text-primary">Total Alojamiento S/</label>
                    <input type="number" id="edit_total" class="form-control fw-bold" value="${r.total}">
                    <small class="text-muted">Cambiar esto afectar√° la deuda pendiente.</small>
                </div>
                <div class="col-12 mt-4 d-flex gap-2">
                    <button class="btn btn-primary w-100" onclick="guardarEdicion(${r.id})">üíæ Guardar Cambios</button>
                    <button class="btn btn-secondary w-100" onclick="verDetalle(${r.habNum}, ${r.id})">Cancelar</button>
                </div>
            </div>
        `;
        document.getElementById('mb').innerHTML = htmlForm;
    }

    function guardarEdicion(id) {
        const r = ress.find(x => x.id == id);
        if(!r) return;

        const nuevoCliente = document.getElementById('edit_cliente').value;
        const nuevoDni = document.getElementById('edit_dni').value;
        const nuevoCel = document.getElementById('edit_celular').value;
        const nuevasPersonas = document.getElementById('edit_personas').value;
        const nuevoIn = document.getElementById('edit_in').value;
        const nuevoOut = document.getElementById('edit_out').value;
        const nuevoTotal = parseFloat(document.getElementById('edit_total').value) || 0;

        if(!nuevoCliente) return alert("El nombre es obligatorio");

        // Validar fechas
        if(!validarDisponibilidad(r.habNum, nuevoIn, nuevoOut, r.id)) {
            return alert("‚ö†Ô∏è Conflicto de fechas: La habitaci√≥n est√° ocupada en ese rango.");
        }

        // Guardar
        r.cliente = nuevoCliente;
        r.dni = nuevoDni;
        r.celular = nuevoCel;
        r.personas = nuevasPersonas;
        r.in = nuevoIn;
        r.out = nuevoOut;
        r.total = nuevoTotal;

        localStorage.setItem('sumaj_ress_v5', JSON.stringify(ress));
        registrarLog("EDITAR", `Reserva ${r.id} modificada`);
        
        alert("Datos actualizados correctamente.");
        actualizarPantalla();
        renderCal();
        verDetalle(r.habNum, r.id); // Volver a la vista normal
    }

    function verDetalle(num,id,isH){
        if(!modalInstance)modalInstance=new bootstrap.Modal(document.getElementById('modalH'));
        let r;
        if(id) r = isH ? historial.find(x=>x.id==id) : ress.find(x=>x.id==id);
        else {
            const f=document.getElementById('filtroFecha').value;
            r=ress.find(x=>x.habNum==num&&(f>=x.in&&f<=x.out));
        }

        // Si la habitaci√≥n est√° vac√≠a (gesti√≥n de limpieza)
        if(!r){
            const st=limpieza[num]||'limpia';
            let b='';
            let icon='';
            if(st==='sucia') { b=`<button class="btn btn-primary w-100" onclick="setEstadoLimpieza(${num},'limpieza');modalInstance.hide()">Empezar Limpieza</button>`; icon='<i class="fas fa-broom fa-3x text-warning mb-3"></i>'; }
            else if(st==='limpieza') { b=`<button class="btn btn-success w-100" onclick="setEstadoLimpieza(${num},'limpia');modalInstance.hide()">Terminar Limpieza</button>`; icon='<i class="fas fa-pump-soap fa-3x text-primary mb-3"></i>'; }
            else { b=`<button class="btn btn-warning w-100" onclick="setEstadoLimpieza(${num},'sucia');modalInstance.hide()">Marcar Sucia</button>`; icon='<i class="fas fa-check-circle fa-3x text-success mb-3"></i>'; }
            
            document.getElementById('mt').innerHTML = `<span class="badge bg-secondary">Hab ${num}</span> Gesti√≥n de Estado`;
            document.getElementById('mb').innerHTML=`<div class="text-center py-5">${icon}<h5>${st.toUpperCase()}</h5><div class="mt-4 px-5">${b}</div></div>`;
            modalInstance.show();
            return;
        }

        // Datos del hu√©sped y c√°lculos
        const cons = r.consumos || [];
        const tCons = cons.reduce((a,b)=>a+(b.precio*b.cantidad),0);
        const granT = isH ? r.totalFinal : (r.total+tCons);
        const deu = isH ? 0 : (granT-r.adelanto);
        const hBtn = isH ? 'display:none' : '';
        let ops = '<option value="">Agregar Producto/Servicio...</option>';
        inventario.forEach(p => ops += `<option value="${p.id}">${p.nombre} - S/${p.precio}</option>`);

        let badgeEstado = '';
        if(isH) badgeEstado = '<span class="badge bg-secondary"><i class="fas fa-history me-1"></i> Historial</span>';
        else if(deu < 0.1) badgeEstado = '<span class="badge bg-success"><i class="fas fa-check me-1"></i> Pagado</span>';
        else badgeEstado = '<span class="badge bg-danger"><i class="fas fa-exclamation-circle me-1"></i> Falta Pago</span>';

        document.getElementById('mt').innerHTML = `
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-dark fs-5">HAB ${num}</span>
                ${badgeEstado}
            </div>`;

        // Construcci√≥n del HTML Interno (Dise√±o Premium)
        let html = `
        <div class="row g-0">
            <div class="col-lg-7 p-4 border-end">
                
                <div class="d-flex justify-content-between align-items-center mb-2">
                     <div class="detail-label">Hu√©sped</div>
                     ${!isH ? `<button class="btn btn-sm btn-outline-primary py-0" style="font-size:0.7rem;" onclick="editarReserva(${r.id})"><i class="fas fa-edit"></i> Editar Datos</button>` : ''}
                </div>
                <div class="row g-3 mb-4">
                    <div class="col-12">
                        <div class="detail-value fs-5"><i class="fas fa-user-circle text-secondary me-2"></i>${r.cliente}</div>
                    </div>
                    <div class="col-6">
                        <div class="detail-label">Check-In</div>
                        <div class="detail-value"><i class="fas fa-calendar-check text-success me-2"></i>${r.in}</div>
                    </div>
                    <div class="col-6">
                        <div class="detail-label">Check-Out</div>
                        <div class="detail-value"><i class="fas fa-calendar-times text-danger me-2"></i>${r.out}</div>
                    </div>
                    <div class="col-6">
                        <div class="detail-label">Personas</div>
                        <div class="detail-value"><i class="fas fa-users text-primary me-2"></i>${r.personas}</div>
                    </div>
                    <div class="col-6">
                        <div class="detail-label">Contacto</div>
                        <div class="detail-value"><i class="fas fa-phone text-dark me-2"></i>${r.celular || '-'}</div>
                    </div>
                </div>

                <hr class="text-muted opacity-25">

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold m-0 text-primary"><i class="fas fa-cocktail me-2"></i>Consumos Adicionales</h6>
                </div>

                <div class="input-group input-group-sm mb-3" style="${hBtn}">
                    <select id="selP" class="form-select border-primary">${ops}</select>
                    <input id="selQ" type="number" value="1" class="form-control border-primary" style="max-width: 60px;">
                    <button class="btn btn-primary" onclick="addCons(${r.id})"><i class="fas fa-plus"></i></button>
                </div>

                <div class="table-responsive border rounded bg-white" style="max-height: 200px; overflow-y:auto;">
                    <table class="table table-sm table-striped m-0 cons-table">
                        <thead><tr><th>Cant</th><th>Item</th><th class="text-end">Total</th><th class="text-center" style="${hBtn}">Borrar</th></tr></thead>
                        <tbody>
                            ${cons.length > 0 ? cons.map((c,i) => `
                                <tr>
                                    <td class="text-center fw-bold">${c.cantidad}</td>
                                    <td>${c.item}</td>
                                    <td class="text-end">S/ ${(c.precio*c.cantidad).toFixed(2)}</td>
                                    <td class="text-center" style="${hBtn}"><i class="fas fa-trash text-danger cursor-pointer" onclick="delCons(${r.id},${i})"></i></td>
                                </tr>
                            `).join('') : '<tr><td colspan="4" class="text-center text-muted py-3 small">Sin consumos registrados</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="col-lg-5 p-4 bg-light d-flex flex-column">
                
                <h6 class="fw-bold text-dark mb-3"><i class="fas fa-file-invoice-dollar me-2"></i>Resumen Financiero</h6>
                
                <div class="total-box mb-4 shadow-sm">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Alojamiento:</span>
                        <span class="fw-bold">S/ ${r.total.toFixed(2)}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Consumos:</span>
                        <span class="fw-bold">S/ ${tCons.toFixed(2)}</span>
                    </div>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="fs-5 fw-bold text-dark">TOTAL:</span>
                        <span class="fs-5 fw-bold text-dark">S/ ${granT.toFixed(2)}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-success fw-bold">Pagado:</span>
                        <span class="text-success fw-bold">- S/ ${r.adelanto.toFixed(2)}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top border-secondary-subtle">
                        <span class="fw-bold text-danger">PENDIENTE:</span>
                        <span class="${deu > 0.1 ? 'debt-high' : 'debt-ok'}">S/ ${deu.toFixed(2)}</span>
                    </div>
                </div>

                <div class="mt-auto d-grid gap-2">
                    ${!isH && deu > 0.1 ? `<button class="btn btn-success fw-bold py-2 shadow-sm" onclick="pay(${r.id},${deu})"><i class="fas fa-money-bill-wave me-2"></i>COBRAR DEUDA</button>` : ''}
                    
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary" onclick="printR(${r.id},${isH})"><i class="fas fa-print me-1"></i> Ticket</button>
                        ${!isH ? `<button class="btn btn-outline-success" onclick="enviarWhatsapp(${r.id})"><i class="fab fa-whatsapp me-1"></i> WhatsApp</button>` : ''}
                    </div>

                    ${!isH ? `<button class="btn btn-dark fw-bold py-2 mt-2" onclick="checkOut(${r.id},${deu})"><i class="fas fa-sign-out-alt me-2"></i>FINALIZAR ESTANCIA</button>` : ''}
                </div>
            </div>
        </div>
        `;
        
        document.getElementById('mb').innerHTML = html;
        modalInstance.show();
    }

    function enviarWhatsapp(id) {
        const r = ress.find(x => x.id == id);
        if (!r) return;
        const salto = "%0A";
        const msg = `*HOLA, ${r.cliente.toUpperCase()}* üå¥${salto}Su reserva en SUMAJ LAGOON LODGE est√° confirmada.${salto}${salto}üìÖ *Check-in:* ${r.in}${salto}üìÖ *Check-out:* ${r.out}${salto}üè† *Habitaci√≥n:* ${r.habNum} (${r.tipo})${salto}üë• *Personas:* ${r.personas}${salto}üí∞ *Total:* S/ ${r.total}${salto}üíµ *A cuenta:* S/ ${r.adelanto}${salto}${salto}¬°Los esperamos en Sauce! üö§`;
        let cel = r.celular.replace(/\D/g, ''); 
        if (cel.length === 9) cel = '51' + cel;
        window.open(`https://wa.me/${cel}?text=${msg}`, '_blank');
    }

    function addCons(id){const pid=parseInt(document.getElementById('selP').value),q=parseInt(document.getElementById('selQ').value);const p=inventario.find(i=>i.id===pid);if(p.tipo==='producto'&&p.stock<q)return alert("Sin stock");if(p.tipo==='producto'){p.stock-=q;localStorage.setItem('sumaj_inv_v2',JSON.stringify(inventario));}const r=ress.find(x=>x.id==id);if(!r.consumos)r.consumos=[];r.consumos.push({idProd:p.id,item:p.nombre,precio:p.precio,cantidad:q,tipo:p.tipo});localStorage.setItem('sumaj_ress_v5',JSON.stringify(ress));verDetalle(r.habNum,id);}
    function delCons(id,i){const r=ress.find(x=>x.id==id),it=r.consumos[i];if(it.idProd&&it.tipo==='producto'){const p=inventario.find(x=>x.id===it.idProd);if(p){p.stock+=it.cantidad;localStorage.setItem('sumaj_inv_v2',JSON.stringify(inventario));}}r.consumos.splice(i,1);localStorage.setItem('sumaj_ress_v5',JSON.stringify(ress));verDetalle(r.habNum,id);}
    function pay(id,m){if(confirm("¬øCobrar?")){const r=ress.find(x=>x.id==id);r.adelanto+=m;localStorage.setItem('sumaj_ress_v5',JSON.stringify(ress));verDetalle(r.habNum,id);renderCal();}}
    function printR(id,isH){const r=isH?historial.find(x=>x.id==id):ress.find(x=>x.id==id);const tc=(r.consumos||[]).reduce((a,b)=>a+(b.precio*b.cantidad),0);const tg=isH?r.totalFinal:(r.total+tc);const d=isH?0:(tg-r.adelanto);let i=(r.consumos||[]).map(c=>`<tr><td>${c.cantidad}x ${c.item}</td><td>S/${(c.precio*c.cantidad).toFixed(2)}</td></tr>`).join('');const w=window.open('','PRINT','height=600,width=400');w.document.write(`<html><body><h3>SUMAJ</h3><p>${r.cliente}</p><table><tr><td>Aloj</td><td>S/${r.total}</td></tr>${i}</table><hr><p>TOTAL: S/${tg}<br>PAGADO: S/${r.adelanto}<br>DEUDA: S/${d.toFixed(2)}</p></body></html>`);w.print();w.close();}
    function toggleAdelanto(){document.getElementById('divAdelanto').style.display=document.getElementById('pagoEstado').value==='Adelanto'?'block':'none';}
    function toggleAdelantoCal(){document.getElementById('divAdelantoCal').style.display=document.getElementById('c_pagoEstado').value==='Adelanto'?'block':'none';}
    function toggleStockInput(){const t=document.getElementById('invTipo').value;document.getElementById('divStockInput').style.display=t==='servicio'?'none':'block';}
    function guardarMovimientoCaja(){const t=document.getElementById('cajaTipo').value,d=document.getElementById('cajaDesc').value,m=parseFloat(document.getElementById('cajaMonto').value);if(!d||!m)return;caja.push({id:Date.now(),fecha:new Date().toLocaleString(),tipo:t,cat:document.getElementById('cajaCat').value,desc:d,monto:m});localStorage.setItem('sumaj_caja_v1',JSON.stringify(caja));registrarLog("CAJA",`${t}: ${m}`);renderCaja();document.getElementById('cajaDesc').value='';document.getElementById('cajaMonto').value='';}
    function renderCaja(){const t=document.getElementById('bodyCaja');t.innerHTML='';let s=0;[...caja].reverse().forEach(m=>{if(m.tipo==='ingreso')s+=m.monto;else s-=m.monto;t.innerHTML+=`<tr><td>${m.fecha.split(',')[0]}</td><td>${m.tipo}</td><td>${m.cat}</td><td>${m.desc}</td><td>S/${m.monto}</td><td><button class="btn btn-sm text-danger" onclick="delCaja(${m.id})">x</button></td></tr>`;});document.getElementById('cajaSaldo').innerText=`S/${s.toFixed(2)}`;}
    function delCaja(id){if(verificarPermisoAdmin()&&confirm("Borrar?")){caja=caja.filter(x=>x.id!==id);localStorage.setItem('sumaj_caja_v1',JSON.stringify(caja));renderCaja();}}
    
    function guardarReservaCal(){
        const d=(id)=>document.getElementById(id).value;
        const t=parseFloat(d('c_total'))||0;
        let ad=d('c_pagoEstado')==='Pagado'?t:(d('c_pagoEstado')==='Adelanto'?parseFloat(d('c_adelanto')):0);
        
        if(!d('c_cliente'))return alert("Falta nombre");
        
        const selHab = parseInt(d('c_habSelect'));
        let tipo = d('c_tipoHab');
        if(document.getElementById('c_tipoHab').disabled) {
            const hObj = habs.find(h=>h.num === selHab);
            if(hObj) tipo = hObj.tipo;
        }

        if(!validarDisponibilidad(selHab,d('c_in'),d('c_out')))return alert("Ocupado");
        
        ress.push({id:Date.now(),cliente:d('c_cliente'),dni:d('c_dni'),personas:d('c_numPersonas'),celular:d('c_celular'),habNum:selHab,tipo:tipo,in:d('c_in'),out:d('c_out'),total:t,adelanto:ad,medioPago:d('c_medioPago'),consumos:[]});
        localStorage.setItem('sumaj_ress_v5',JSON.stringify(ress));
        registrarLog("RES_CAL",`Hab ${selHab}`);
        modalResCal.hide();renderCal();alert("Creada");
    }

    function abrirModalReservaCal(){if(!modalResCal)modalResCal=new bootstrap.Modal(document.getElementById('modalResCal'));const s=document.getElementById('c_habSelect');s.innerHTML='';habs.forEach(h=>s.innerHTML+=`<option value="${h.num}">${h.num}</option>`);document.getElementById('c_in').value=hoy;document.getElementById('c_out').value=hoy;toggleAdelantoCal();modalResCal.show();checkTipoHab('cal');}
    function agregarProducto(){if(!checkPermiso('nav-inventario'))return;const t=document.getElementById('invTipo').value,n=document.getElementById('invNombre').value,p=parseFloat(document.getElementById('invPrecio').value);let s=parseInt(document.getElementById('invStock').value);if(!n)return;if(t==='servicio')s=9999;inventario.push({id:Date.now(),nombre:n,precio:p,stock:s,tipo:t});localStorage.setItem('sumaj_inv_v2',JSON.stringify(inventario));renderInventario();document.getElementById('invNombre').value='';}
    function renderInventario(){const t=document.getElementById('tablaInventario');t.innerHTML='';inventario.forEach(p=>{t.innerHTML+=`<tr><td>${p.nombre}</td><td>${p.tipo}</td><td>${p.precio}</td><td>${p.tipo==='servicio'?'-':p.stock}</td><td><button class="btn btn-sm btn-danger" onclick="delInv(${p.id})">x</button></td></tr>`;});}
    function delInv(id){if(verificarPermisoAdmin()&&confirm("Borrar?")){inventario=inventario.filter(x=>x.id!==id);localStorage.setItem('sumaj_inv_v2',JSON.stringify(inventario));renderInventario();}}
    function actualizarReporte(){const t=document.getElementById('tablaHistorial');t.innerHTML='';const d=document.getElementById('hist_desde').value,h_=document.getElementById('hist_hasta').value;let c=0,p=0,g=0;historial.filter(h=>(!d||h.in>=d)&&(!h_||h.in<=h_)).forEach(h=>{c+=h.adelanto;t.innerHTML+=`<tr><td>${h.habNum}</td><td>${h.personas}</td><td>${h.cliente}</td><td>${h.in}</td><td>${h.totalFinal}</td><td>${h.adelanto}</td><td>${h.fechaCierre}</td></tr>`;});caja.forEach(x=>{if(x.tipo==='egreso')g+=x.monto;else c+=x.monto;});document.getElementById('dashCobrado').innerText=c;document.getElementById('dashGastos').innerText=g;document.getElementById('dashUtilidad').innerText=(c-g);}
    function actualizarOperaciones(){const f=document.getElementById('fechaOp').value,i=document.getElementById('listIn'),o=document.getElementById('listOut');i.innerHTML='';o.innerHTML='';ress.forEach(r=>{let h=`<div class="op-card ${r.in===f?'op-in':'op-out'}"><b>${r.habNum}</b> ${r.cliente}</div>`;if(r.in===f)i.innerHTML+=h;if(r.out===f)o.innerHTML+=h;});}
    function togglePasswords(){showPass=!showPass;renderUsuarios();}
    function guardarUsuario(){if(!verificarPermisoAdmin())return;const u=document.getElementById('newUserName').value,p=document.getElementById('newUserPass').value,idx=parseInt(document.getElementById('editUserIndex').value);if(!u||!p)return;const m=Array.from(document.querySelectorAll('.mod-check:checked')).map(x=>x.value);if(idx===-1)users.push({user:u,pass:p,modules:m});else{users[idx].user=u;users[idx].pass=p;users[idx].modules=m;}localStorage.setItem('sumaj_users_v1',JSON.stringify(users));renderUsuarios();limpiarFormUsuario();alert("Guardado");}
    function renderUsuarios(){const t=document.getElementById('tablaUsuarios');t.innerHTML='';users.forEach((u,i)=>{t.innerHTML+=`<tr><td>${u.user}</td><td>${showPass?u.pass:'***'}</td><td>${u.modules.includes('all')?'TOTAL':u.modules.length}</td><td>${u.user!=='admin'?`<button class="btn btn-sm btn-info" onclick="editUser(${i})">E</button><button class="btn btn-sm btn-danger" onclick="delUser('${u.user}')">x</button>`:''}</td></tr>`});}
    function editUser(i){const u=users[i];document.getElementById('editUserIndex').value=i;document.getElementById('newUserName').value=u.user;document.getElementById('newUserPass').value=u.pass;document.querySelectorAll('.mod-check').forEach(c=>c.checked=u.modules.includes(c.value)||u.modules.includes('all'));}
    function delUser(u){if(verificarPermisoAdmin()&&confirm("Borrar?")){users=users.filter(x=>x.user!==u);localStorage.setItem('sumaj_users_v1',JSON.stringify(users));renderUsuarios();}}
    function renderLogs(){const t=document.getElementById('tablaLogs');t.innerHTML='';const userFilter=document.getElementById('filterUser').value;const dateFrom=document.getElementById('filterDateFrom').value;const dateTo=document.getElementById('filterDateTo').value;logs.forEach(l=>{let pass=true;const logDate=l.dateIso.split('T')[0];if(userFilter&&l.user!==userFilter)pass=false;if(dateFrom&&logDate<dateFrom)pass=false;if(dateTo&&logDate>dateTo)pass=false;if(pass)t.innerHTML+=`<tr><td>${l.dateStr}</td><td>${l.user}</td><td>${l.action}</td><td>${l.details}</td></tr>`;});}
    function imprimirLogs(){const w=window.open('');w.document.write(document.getElementById('printLogsArea').innerHTML);w.print();}
    function exportarCalPDF(){const d=new jsPDF('l','mm','a4');d.text("Calendario",10,10);html2canvas(document.getElementById('calContainer')).then(c=>{d.addImage(c.toDataURL(),'PNG',10,20,280,0);d.save('cal.pdf');});}
    function exportarCalImg(){html2canvas(document.getElementById('calContainer')).then(c=>{const a=document.createElement('a');a.href=c.toDataURL();a.download='cal.png';a.click();});}
    function descargarBackup(){if(!checkPermiso('nav-config')) return; const d={habs,ress,historial,inv:inventario,caja:caja,users:users,ver:'19.14',date:new Date()};const b=new Blob([JSON.stringify(d)],{type:'json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='backup.json';a.click();}
    function restaurarBackup(){if(!checkPermiso('nav-config')) return; const f=document.getElementById('fileBackup').files[0];if(!f)return;const r=new FileReader();r.onload=e=>{const d=JSON.parse(e.target.result);if(d.habs){habs=d.habs;ress=d.ress;historial=d.historial;inventario=d.inv||[];caja=d.caja||[];users=d.users||users;localStorage.setItem('sumaj_habs_v5',JSON.stringify(habs));localStorage.setItem('sumaj_ress_v5',JSON.stringify(ress));localStorage.setItem('sumaj_hist_v5',JSON.stringify(historial));localStorage.setItem('sumaj_inv_v2',JSON.stringify(inventario));localStorage.setItem('sumaj_caja_v1',JSON.stringify(caja));localStorage.setItem('sumaj_users_v1',JSON.stringify(users));alert("Restaurado");location.reload();}};r.readAsText(f);}
    
    function exportarExcel() {
        const tabla = document.getElementById('tablaHistorialHTML');
        let html = tabla.outerHTML;
        const uri = 'data:application/vnd.ms-excel;base64,';
        const template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"></head><body><table>{table}</table></body></html>';
        const base64 = function(s) { return window.btoa(unescape(encodeURIComponent(s))) };
        const format = function(s, c) { return s.replace(/{(\w+)}/g, function(m, p) { return c[p]; }) };
        const ctx = { table: html };
        const link = document.createElement("a");
        link.href = uri + base64(format(template, ctx));
        const fecha = new Date().toISOString().split('T')[0];
        link.download = `Reporte_Sumaj_${fecha}.xls`;
        link.click();
    }

    // --- GESTOR HABITACIONES ---
    function renderConfigHabs() {
        const t = document.getElementById('bodyConfigHabs');
        t.innerHTML = '';
        habs.sort((a,b) => {
            if(a.piso < b.piso) return -1;
            if(a.piso > b.piso) return 1;
            return a.num - b.num;
        });
        habs.forEach(h => {
            t.innerHTML += `<tr><td class="fw-bold">${h.num}</td><td>${h.piso}</td><td><button class="btn btn-sm btn-outline-primary me-1" onclick="editarHabConfig(${h.num})"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="eliminarHabConfig(${h.num})"><i class="fas fa-trash"></i></button></td></tr>`;
        });
    }
    function agregarHabitacion() {
        if(!checkPermiso('nav-config')) return;
        const n = parseInt(document.getElementById('confNum').value);
        const p = document.getElementById('confPiso').value;
        if(n && p){
            if(habs.some(h=>h.num === n)) return alert("N√∫mero ya existe");
            habs.push({num:n, piso:p}); saveHabs();
            document.getElementById('confNum').value = '';
            document.getElementById('confPiso').value = '';
        }
    }
    function editarHabConfig(num) {
        if(!checkPermiso('nav-config')) return;
        const h = habs.find(x => x.num == num);
        const newPiso = prompt(`Editar Piso para Hab ${num}:`, h.piso);
        if(newPiso !== null) { h.piso = newPiso; saveHabs(); }
    }
    function eliminarHabConfig(num) {
        if(!checkPermiso('nav-config')) return;
        if(confirm(`¬øEliminar Hab ${num}?`)) { habs = habs.filter(h => h.num != num); saveHabs(); }
    }
    function saveHabs() { localStorage.setItem('sumaj_habs_v5', JSON.stringify(habs)); renderConfigHabs(); actualizarPantalla(); renderCal(); }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>